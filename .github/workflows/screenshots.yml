# SPDX-FileCopyrightText: 2026 Mateusz Krawczuk <mateusz.krawczuk@cybrixsystems.com>
# SPDX-License-Identifier: GPL-2.0-or-later

name: Screenshots

on:
  workflow_dispatch:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  screenshots:
    name: Generate Screenshots
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qt6-base-dev \
            qt6-tools-dev \
            qt6-tools-dev-tools \
            libqt6svg6-dev \
            libqt6network6 \
            libgl1-mesa-dev \
            cmake \
            g++ \
            xvfb \
            x11-utils \
            xdotool \
            imagemagick \
            openbox \
            xterm \
            qemu-system-x86 \
            fonts-dejavu-core

      - name: Build QtEmu
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release --parallel

      - name: Generate screenshots
        run: |
          # Start Xvfb with a good resolution
          export DISPLAY=:99
          Xvfb :99 -screen 0 1280x1024x24 &
          XVFB_PID=$!
          sleep 2

          # Start a lightweight window manager for proper window decoration
          openbox &
          sleep 1

          # Run the screenshot script
          chmod +x .github/scripts/take_screenshots.sh
          bash .github/scripts/take_screenshots.sh screenshots || true

          # Cleanup
          kill $XVFB_PID 2>/dev/null || true
        env:
          DISPLAY: ':99'
          QT_QPA_PLATFORM: xcb

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: QtEmu-Screenshots
          path: screenshots/
          retention-days: 3
          if-no-files-found: warn
